<Window x:Class="FlowEvents.Users.PermissionWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
        xmlns:local="clr-namespace:FlowEvents.Users"
        xmlns:behavior="clr-namespace:FlowEvents.Behaviors"
        mc:Ignorable="d" 
        Height="800" Width="1400"
        WindowStartupLocation="CenterScreen">


    <Window.Resources>
        <!-- Стили для современного интерфейса -->
        <Style x:Key="ModernButton" TargetType="Button">
            <Setter Property="Background" Value="#007ACC"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="10 5"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <Style x:Key="HeaderText" TargetType="TextBlock">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="0 0 0 10"/>
        </Style>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Индикатор загрузки -->
        <!--<Border Grid.Row="0" Grid.RowSpan="3" Background="#CCFFFFFF" 
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                Panel.ZIndex="1">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="20"/>
                <TextBlock Text="Загрузка данных..." Margin="0 10 0 0" HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>-->

        <!-- Заголовок -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0 0 0 20">
            <TextBlock Text="🛡️" FontSize="24" Margin="0 0 10 0"/>
            <TextBlock Text="Управление правами пользователей" 
                      FontSize="20" FontWeight="Bold"/>
        </StackPanel>

        <!-- Основной контент -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="1.5*"/>
            </Grid.ColumnDefinitions>

            <!-- Левая панель - Пользователи -->
            <DockPanel Grid.Column="0" LastChildFill="True" Margin="0 0 10 0">

                <TextBlock DockPanel.Dock="Top" Text="👥 Пользователи" Style="{StaticResource HeaderText}"/>

                <WrapPanel  DockPanel.Dock="Bottom"  Orientation="Horizontal" Margin="0 10 0 0" >
                    <Button x:Name="AddUserButton" Content="👤➕ Добавить локального пользователя" 
                            Command="{Binding OpenAddUserWindowCommand}"
                            Style="{StaticResource ModernButton}"/>
                    <Button x:Name="AddDomainUserButton" Content="🌐 👤 Добавить доменного пользователя"
                            Command="{Binding DomainUserSearchWindowCommand}"
                            Style="{StaticResource ModernButton}"/>
                    <Button Content="🗑️ Удалить пользователя" Command="{Binding DeleteUserCommand}"
                            Style="{StaticResource ModernButton}"/>
                    <Button Content="🔄 Обновить данные" Command="{Binding LoadDataCommand}"
                            Style="{StaticResource ModernButton}"/>
                </WrapPanel>

                <ListView x:Name="UsersListView"
                            SelectionMode="Single"
                            ItemsSource="{Binding Users}" 
                            SelectedItem="{Binding SelectedUser}">
                        <i:Interaction.Behaviors>
                            <behavior:ClearSelectionBehavior/>
                        </i:Interaction.Behaviors>
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="ID" Width="50" DisplayMemberBinding="{Binding Id}"/>
                            <GridViewColumn Header="Доступ" Width="60">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <!--<CheckBox IsChecked="{Binding IsAllowedBool}"  HorizontalAlignment="Center"/>-->
                                        <CheckBox IsChecked="{Binding IsAllowedBool}" 
                                                  Command="{Binding DataContext.UpdateUserAccessCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                  CommandParameter="{Binding}"
                                                  HorizontalAlignment="Center"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Header="Логин" Width="150" DisplayMemberBinding="{Binding UserName}"/>
                            <GridViewColumn Header="Отображаемое имя" Width="150" DisplayMemberBinding="{Binding DisplayName}"/>

                            <!-- Колонка с ComboBox для выбора роли -->
                            <GridViewColumn Header="Роль" Width="120">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding DataContext.Roles, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                  DisplayMemberPath="RoleName"
                                                  SelectedValuePath="RoleId"
                                                  SelectedValue="{Binding RoleId, UpdateSourceTrigger=PropertyChanged}"
                                                  Width="110"
                                                  Height="22">
                                            <i:Interaction.Triggers>
                                                <i:EventTrigger EventName="SelectionChanged">
                                                    <i:InvokeCommandAction Command="{Binding DataContext.UpdateUserRoleCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                               CommandParameter="{Binding}"/>
                                                </i:EventTrigger>
                                            </i:Interaction.Triggers>
                                        </ComboBox>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <!--<GridViewColumn Header="Роль" Width="100" DisplayMemberBinding="{Binding RoleName}"/>-->
                            <GridViewColumn Header="Email" Width="150" DisplayMemberBinding="{Binding Email}"/>
                            <GridViewColumn Header="Доменное имя" Width="100" DisplayMemberBinding="{Binding DomainName}"/>

                        </GridView>
                    </ListView.View>
                </ListView>
            </DockPanel>

            <!-- Средняя панель - Роли -->
            <DockPanel Grid.Column="1" LastChildFill="True" Margin="0 0 10 0">
                <TextBlock DockPanel.Dock="Top" Text="Роли" Style="{StaticResource HeaderText}" />

                <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" Margin="0 10 0 0">
                    <Button x:Name="AddRoleButton" Content="Добавить роль" 
                           Style="{StaticResource ModernButton}"/>
                    <Button Content="🔄 Обновить данные" Command="{Binding LoadDataCommand}"
                           Style="{StaticResource ModernButton}"/>
                </StackPanel>
                <ListView x:Name="RolesListView" 
                         SelectionMode="Single"
                         ItemsSource="{Binding Roles}" SelectedItem="{Binding SelectedRole}">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="ID" Width="50" DisplayMemberBinding="{Binding RoleId}"/>
                            <GridViewColumn Header="Название" Width="150" DisplayMemberBinding="{Binding RoleName}"/>
                            <GridViewColumn Header="Описание" Width="200" DisplayMemberBinding="{Binding Description}"/>
                        </GridView>
                    </ListView.View>
                </ListView>
            </DockPanel>


            <!-- Правая панель - Права доступа -->
            <DockPanel Grid.Column="2" LastChildFill="True" Margin="0 0 0 0">
                <TextBlock DockPanel.Dock="Top" Text="Права доступа для выбранной роли" Style="{StaticResource HeaderText}"/>
                
                <TextBlock DockPanel.Dock="Top" x:Name="SelectedRoleText" Margin="0 0 0 10" 
                            Text="{Binding SelectedRole.RoleName, StringFormat='Выбрана роль: {0}'}" 
                            FontWeight="Bold" Foreground="Gray"
                            Visibility="{Binding SelectedRole, Converter={StaticResource NullToVisibilityConverter}}"/>
                
                <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0 15 0 0">
                    <Button x:Name="SelectAllButton" Content="Выбрать все" 
                            Command="{Binding SelectAllCommand}"
                           Style="{StaticResource ModernButton}" Background="#28A745"/>
                    <Button x:Name="DeselectAllButton" Content="Снять все"
                            Command="{Binding DeselectAllCommand}"
                           Style="{StaticResource ModernButton}" Background="#DC3545"/>
                    <Button x:Name="SavePermissionsButton" Content="Сохранить права" 
                           Style="{StaticResource ModernButton}" Background="#17A2B8"/>
                </StackPanel>
                
                <ScrollViewer VerticalScrollBarVisibility="Auto" >
                    <ItemsControl x:Name="PermissionsList"
                                  ItemsSource="{Binding Permissions}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <CheckBox Content="{Binding PermissionName}" 
                                          IsChecked="{Binding IsGranted}"
                                          ToolTip="{Binding Description}"
                                         Margin="0 5 0 0"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
                
            </DockPanel>
        </Grid>

        <!-- Нижняя панель с кнопками -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0 20 0 0">
            <Button x:Name="ApplyButton" Content="Применить" 
                   Style="{StaticResource ModernButton}" Width="100"/>
            <Button x:Name="CancelButton" Content="Отмена" 
                   Style="{StaticResource ModernButton}" Background="#6C757D" Width="100"/>
            <Button Content="Закрыть" Width="100" Height="30"
                   Click="CloseButton_Click"/>
        </StackPanel>
    </Grid>
</Window>
